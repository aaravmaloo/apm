name: TEST YML

on:
  push:
  pull_request:

jobs:
  test:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # ---------- BUILD ----------
      - name: Build APM (Windows)
        if: runner.os == 'Windows'
        run: go build -o pm.exe

      - name: Build APM (Linux/macOS)
        if: runner.os != 'Windows'
        run: go build -o pm

      # ---------- WINDOWS TESTS ----------
      - name: CLI command tests (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $pm = ".\pm.exe"

          $commands = @(
            "--help",
            "init --help",
            "info --help",
            "add --help",
            "edit --help",
            "del --help",
            "get --help",
            "gen --help",
            "scan --help",
            "audit --help",
            "cinfo --help",
            "unlock --help",
            "readonly --help",
            "lock --help",
            "import --help",
            "export --help",
            "totp --help",
            "totp show --help"
          )

          foreach ($cmd in $commands) {
            Write-Host "Testing: pm $cmd"
            & $pm $cmd.Split(" ")
            if ($LASTEXITCODE -ne 0) { exit 1 }
          }

      # ---------- LINUX / MAC TESTS ----------
      - name: CLI command tests (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          chmod +x ./pm

          commands=(
            "--help"
            "init --help"
            "info --help"
            "add --help"
            "edit --help"
            "del --help"
            "get --help"
            "gen --help"
            "scan --help"
            "audit --help"
            "cinfo --help"
            "unlock --help"
            "readonly --help"
            "lock --help"
            "import --help"
            "export --help"
            "totp --help"
            "totp show --help"
          )

          for cmd in "${commands[@]}"; do
            echo "Testing: pm $cmd"
            ./pm $cmd || exit 1
          done
